name: Rewrite release description to use scarf URLs

on:
  workflow_call:
    inputs:
      # comes from cargo-dist workflow call
      plan:
        required: true
        type: string

env:
  PLAN: ${{ inputs.plan }}

jobs:
  scarf:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Amend GitHub Release
        run: |
          # Download the release notes
          gh release view --json body -q '.body' > "$RUNNER_TEMP/notes.txt"

          # Set the Scarf download URLs
          sed -i -E 's%https://github.com/restatedev/restate/releases/download/([^/]+)/(.+\.tar\.xz)%https://restate.gateway.scarf.sh/\1/\2%g' "$RUNNER_TEMP/notes.txt"

          # Update the release notes
          gh release edit "${{ github.ref_name }}" --notes-file "$RUNNER_TEMP/notes.txt"
