# Restate v1.6.2 Release Notes

## Highlights

- **Critical bug fix for lazy state keys**: Fixed incorrect protobuf encoding of `GetLazyStateKeys` journal entries that caused invocations using `ctx.stateKeys()` with lazy state to get stuck in retry loops.
- **SQL query robustness**: Fixed tolerance for incorrect column indices in DataFusion predicates.
- **Helm chart improvements**: New `image.tag` and `image.digest` fields (deprecating the `version` field) for more conventional and flexible image configuration.
- **Web UI updated to v0.1.49**: Added lazy state support and bug fixes.

---

## Table of Contents

- [Bug Fixes](#bug-fixes)
  - [Fix Incorrect Encoding of GetLazyStateKeys Journal Entries](#fix-incorrect-encoding-of-getlazystatekeys-journal-entries)
  - [SQL Query Predicate Tolerance](#sql-query-predicate-tolerance)
  - [Fix clamp_max Return Value](#fix-clamp_max-return-value)
- [Deprecations](#deprecations)
  - [Helm Chart image.tag and image.digest](#helm-chart-imagetag-and-imagedigest)
- [Improvements](#improvements)
  - [Web UI](#web-ui)

---

## Bug Fixes

### Fix Incorrect Encoding of GetLazyStateKeys Journal Entries

**Issue**: The server incorrectly stored `GetLazyStateKeys` commands (triggered by `ctx.stateKeys()`) as `GetLazyState` commands in the journal. When these invocations were replayed (e.g., after suspending and resuming in request-response mode), a journal mismatch error (code `570`) caused invocations to get stuck in a retry loop.

**Symptoms**: If you are using lazy state (`enableLazyState: true`) and your handler calls `ctx.stateKeys()`, you may see:
```
Found a mismatch between the code paths taken during the previous execution...
 - The previous execution ran and recorded: 'get state keys'
 - The current execution attempts to perform: 'get state'
```

**Note**: This only affects handlers with lazy state enabled that call `ctx.stateKeys()`. Handlers using eager state or only calling `ctx.get(key)` are not affected. The Java SDK is also not affected.

**Impact**:
- **New invocations** after upgrading work correctly.
- **Existing stuck invocations** have a corrupted journal entry and will not be automatically fixed by upgrading.

**Workaround for Existing Stuck Invocations**:
1. **Kill and re-invoke**: `restate invocations cancel --kill <INVOCATION_ID>`, then re-invoke the handler.
2. **Apply an SDK-side fix** ([restatedev/sdk-shared-core#60](https://github.com/restatedev/sdk-shared-core/pull/60)) that tolerates the mismatched journal entry during replay.

**Related Issues:**
- [#4396](https://github.com/restatedev/restate/issues/4396), [#4397](https://github.com/restatedev/restate/pull/4397)
- [restatedev/sdk-shared-core#60](https://github.com/restatedev/sdk-shared-core/pull/60), [restatedev/sdk-shared-core#61](https://github.com/restatedev/sdk-shared-core/issues/61)

---

### SQL Query Predicate Tolerance

Fixed a crash that could occur when DataFusion generated predicates with incorrect column indices for introspection table queries. The server now gracefully handles out-of-bounds column indices.

**Related Issues:**
- [#4389](https://github.com/restatedev/restate/pull/4389)

---

### Fix clamp_max Return Value

Fixed `clamp_max` incorrectly reporting that a value was clamped when it was within the allowed range. This could cause spurious warnings during metadata schema processing.

---

## Deprecations

### Helm Chart image.tag and image.digest

The `version` field in Helm chart values is now deprecated in favor of `image.tag`. A new `image.digest` field enables pinning images by SHA digest.

**Migration:**
```yaml
# Old (deprecated):
version: "1.6.2"

# New:
image:
  tag: "1.6.2"

# Or pin by digest:
image:
  digest: "sha256:abc123..."
```

The `version` field continues to work but will be removed in a future release. Precedence: `image.digest` > `image.tag` > `version`.

---

## Improvements

### Web UI

Updated to **v0.1.49** (from v0.1.46 in v1.6.1):
- Added support for displaying lazy state entries
- Fixed display of lazy state keys entries
- Minor UI improvements
