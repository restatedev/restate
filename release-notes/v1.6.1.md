# Restate v1.6.1 Release Notes

## Highlights

- **Critical stability fixes**: Resolved leadership thrashing caused by RocksDB memory rebalancing blocking the async runtime, a concurrency token leak when killing invocations, and a memory leak in the networking RPC layer.
- **Significant memory improvements**: Per-invocation memory overhead is dramatically reduced by eliminating high-water-mark buffer retention in protocol encoders and reading journal/state lazily from storage during replay.
- **New features**: Support for `OTEL_RESOURCE_ATTRIBUTES` environment variable, a new `services` column in `sys_deployment`, and weekly Docker image security refreshes.
- **Web UI updates**: Invocation duration column, paused invocation error visibility, and multiple bug fixes.
- **Security updates**: Patched DoS vulnerability in `time` crate (RUSTSEC-2026-0009) and security advisory in `bytes` crate.

---

## Table of Contents

- [Critical Bug Fixes](#critical-bug-fixes)
  - [Leadership Thrashing from Memory Rebalancing](#leadership-thrashing-from-memory-rebalancing)
  - [Memory Leak in RPC Reply Tracker](#memory-leak-in-rpc-reply-tracker)
- [Bug Fixes](#bug-fixes)
  - [Spurious Scheduler Warnings During Leader Transitions](#spurious-scheduler-warnings-during-leader-transitions)
  - [UDFs Missing in Multi-Node SQL Queries](#udfs-missing-in-multi-node-sql-queries)
- [New Features](#new-features)
  - [OTEL_RESOURCE_ATTRIBUTES Support](#otel_resource_attributes-support)
  - [Services Column in sys_deployment](#services-column-in-sys_deployment)
  - [Weekly Docker Image Security Refresh](#weekly-docker-image-security-refresh)
- [Improvements](#improvements)
  - [Memory Improvements](#memory-improvements)
  - [Performance Improvements](#performance-improvements)
  - [Behavioral Changes](#behavioral-changes)
  - [Observability](#observability)
  - [Stability and Security](#stability-and-security)
  - [Web UI](#web-ui)

---

## Critical Bug Fixes

### Leadership Thrashing from Memory Rebalancing

**Issue**: In v1.6.0, RocksDB memory budget rebalancing ran on the tokio async runtime and could block for 50-200ms per column family. This starved the failure detector and metadata server heartbeats, causing nodes to be falsely reported as down. The result was leadership loss, leadership thrashing, and overall cluster instability.

**Fix**: Memory rebalancing is now offloaded to background threads, preventing any blocking of the async runtime.

**Related Issues:**
- [#4371](https://github.com/restatedev/restate/pull/4371)

---

### Memory Leak in RPC Reply Tracker

**Issue**: When internal RPC callers timed out or dropped their receiver before a reply arrived, the corresponding entry in the reply tracker was never cleaned up. Under sustained load with RPC timeouts, this caused unbounded memory growth.

**Fix**: A periodic garbage collection mechanism now removes stale entries from the reply tracker every 5 seconds.

**Related Issues:**
- [#4327](https://github.com/restatedev/restate/pull/4327)

---

### Spurious Scheduler Warnings During Leader Transitions

The cluster scheduler logged alarming warnings about failing to react to cluster state changes during normal leader-to-follower transitions. These warnings were harmless but confusing. The scheduler now gracefully handles `ShutdownError` during transitions.

**Related Issues:**
- [#4377](https://github.com/restatedev/restate/pull/4377)

---

### UDFs Missing in Multi-Node SQL Queries

User-defined functions (UDFs) such as `array_has` and `unnest` were not registered in the remote scanner server, meaning they were unavailable when SQL queries were executed across multiple nodes. This is now fixed.

**Related Issues:**
- [#4317](https://github.com/restatedev/restate/pull/4317)

---

## New Features

### OTEL_RESOURCE_ATTRIBUTES Support

Restate now reads the `OTEL_RESOURCE_ATTRIBUTES` environment variable and merges those attributes into the resource of all exported spans (both service and runtime traces). This allows operators to attach deployment-specific metadata (environment, region, pod name) to traces without changing application configuration.

Restate's own resource attributes (`service.name`, `service.namespace`, `service.version`, `service.instance.id`) take precedence over environment-provided values with the same keys.

**Usage:**
```bash
OTEL_RESOURCE_ATTRIBUTES="deployment.environment=staging,cloud.region=us-east-1" \
  restate-server --tracing-endpoint http://localhost:4317
```

**Note**: This is the only additional `OTEL_*` variable now supported. Other OpenTelemetry environment variables remain ignored â€” use Restate's own configuration for those.

**Related Issues:**
- [#4372](https://github.com/restatedev/restate/pull/4372)

---

### Services Column in sys_deployment

The `sys_deployment` introspection table now includes a `services` column containing the list of service names registered by each deployment. This enables direct SQL queries to find deployments by service name:

```sql
-- Find all deployments that registered a specific service
SELECT id, endpoint, created_at, services
FROM sys_deployment
WHERE array_has(services, 'MyService');

-- List all services and their deployment IDs
SELECT unnest(services) as service, id as deployment_id
FROM sys_deployment;
```

**Related Issues:**
- [#4316](https://github.com/restatedev/restate/pull/4316)

---

### Weekly Docker Image Security Refresh

Restate Docker images are now automatically refreshed weekly to include the latest security updates from the base operating system. Each release now produces date-suffixed tags (e.g., `1.6.1-20260210`) alongside the standard version tags.

| Tag | Example | Description |
|-----|---------|-------------|
| Version | `1.6.1` | Always points to the latest build |
| Version + Date | `1.6.1-20260210` | Specific build from a particular date |
| Minor | `1.6` | Latest patch release of this minor version |

**To receive automatic security updates**, set `imagePullPolicy: Always` (Kubernetes) or `pull_policy: always` (Docker Compose). To pin to a specific image, use a dated tag or digest.

**Related Issues:**
- [#4329](https://github.com/restatedev/restate/issues/4329)

---

## Improvements

### Memory Improvements

#### Eliminated High-Water-Mark Buffer Retention in Protocol Encoders

The service protocol encoder previously retained a per-invocation `BytesMut` buffer sized to the largest message ever encoded (up to 32 MiB for journal entries, and potentially more for eager state). With thousands of concurrent long-lived invocations, this could waste gigabytes of retained-but-unused memory. The encoder now uses right-sized per-message allocations.

Additionally, the in-memory channel between the protocol runner and HTTP client was unbounded; it is now bounded to a capacity of 1 message, preventing buffering buildup.

These changes can reduce memory usage by **gigabytes** in clusters with thousands of concurrent long-lived invocations.

#### Lazy Journal and State Reading During Replay

Previously, when replaying an invocation, the entire journal and full state were materialized into memory before being sent to the service endpoint. Journal entries and state are now read lazily from RocksDB on demand. For invocations with large journals or large state, this dramatically reduces peak memory usage during replay.

---

### Performance Improvements

- **Efficient invocation cleaner scans**: The partition cleaner now filters expired invocations during the storage scan rather than deserializing and filtering after, reducing CPU and memory overhead during cleanup cycles. ([#4337](https://github.com/restatedev/restate/pull/4337))
- **SQL query push-down filters**: SQL queries against introspection tables now apply filters and coalesce record batches during the scan phase, improving query performance for filtered queries on large tables. ([#4308](https://github.com/restatedev/restate/pull/4308))
- **ID encoding performance boost**: Base62 encoding of invocation IDs and other identifiers is now faster. ([#4253](https://github.com/restatedev/restate/pull/4253))

---

### Behavioral Changes

#### Default Trim Delay Changed to 10 Minutes

The `worker.trim-delay-interval` default has been changed from `0s` (immediate) to `10m` (10 minutes). This gives follower replicas time to catch up to the durable LSN before log segments are trimmed, reducing unnecessary re-snapshotting and trim gaps.

To restore the previous behavior:
```toml
[worker]
trim-delay-interval = "0s"
```

Additionally, the `trim-delay-interval` and `durability-mode` configuration options are now visible in the configuration schema (they were previously hidden).

**Related Issues:**
- [#4349](https://github.com/restatedev/restate/pull/4349)

---

### Observability

- **Improved SQL `EXPLAIN` output**: `EXPLAIN` queries for introspection tables now include additional scan metrics and timing information for debugging query performance. ([#4358](https://github.com/restatedev/restate/pull/4358))
- **Heap flamegraph support**: A new `-F heap-flamegraph` debug feature enables memory profiling via jemalloc heap profiling. ([#4324](https://github.com/restatedev/restate/pull/4324))

---

### Stability and Security

- **Updated `time` crate** to fix a denial-of-service vulnerability (RUSTSEC-2026-0009).
- **Updated `bytes` crate** to address a security advisory.
- **Weekly Docker image refreshes** ensure base OS security patches are applied to all maintained releases (see [New Features](#weekly-docker-image-security-refresh)).
- **Reduced unnecessary task spawning**: The networking layer no longer spawns RPC responder tasks when the message router has already dropped the message.

---

### Web UI

Updated to **v0.1.46** with the following changes:

**New features:**
- Invocation duration column in the invocation list view
- Paused invocations now show their error/reason directly in the list view

**Bug fixes:**
- Journal command/entry indexes are now displayed in correct order
- Most recent transient error is now correctly shown (fixed sorting issue)
- "Restart as new" action correctly fetches the invocation payload
- State page properly refreshes after state modifications
- Fixed label rendering issue
